{{define "postman"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ Postman - åœ¨çº¿å·¥å…·é›†</title>
    <meta name="description" content="åŠŸèƒ½å®Œæ•´çš„åœ¨çº¿ Postman å·¥å…·ï¼Œæ”¯æŒ HTTP è¯·æ±‚å‘é€ã€ç¯å¢ƒå˜é‡ç®¡ç†ã€è¯·æ±‚å†å²ç­‰åŠŸèƒ½">
    <meta name="keywords" content="postman, http, api, æµ‹è¯•, åœ¨çº¿å·¥å…·">
    
    <link rel="stylesheet" href="/tools/static/css/style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .postman-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 60px 1fr;
            height: calc(100vh - 120px);
            gap: 1px;
            background: var(--border-color);
        }

        .postman-header {
            grid-column: 1 / -1;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            gap: 1rem;
        }

        .postman-sidebar {
            background: var(--bg-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .postman-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .request-response-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .request-section {
            flex: 1;
            min-height: 200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            resize: vertical;
            position: relative;
        }

        .response-section {
            flex: 1;
            min-height: 200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            resize: vertical;
            position: relative;
        }

        .resize-handle {
            height: 6px;
            background: var(--bg-secondary);
            cursor: row-resize;
            position: relative;
            user-select: none;
        }

        .resize-handle::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 2px;
            background: var(--border-color);
            border-radius: 1px;
        }

        .resize-handle:hover::after {
            background: var(--primary-color);
        }

        .resize-handle.dragging::after {
            background: var(--primary-color);
        }

        .request-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .request-tab {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .request-tab.active {
            background: var(--bg-color);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .request-tab:hover {
            background: var(--bg-hover);
        }

        .tab-content {
            display: none;
            padding: 1rem;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .method-select {
            width: 120px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .url-input {
            flex: 1;
            margin-left: 0.5rem;
        }

        .send-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: var(--primary-hover);
        }

        .send-btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
        }

        .headers-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .headers-table th,
        .headers-table td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .headers-table th {
            background: var(--bg-secondary);
            font-weight: 500;
        }

        .add-header-btn {
            padding: 0.25rem 0.5rem;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .remove-header-btn {
            padding: 0.25rem 0.5rem;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .response-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .response-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .response-tab {
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .response-tab.active {
            background: var(--bg-color);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .response-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .response-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-weight: 500;
            color: var(--text-color);
        }

        .status-success {
            color: var(--success-color);
        }

        .status-error {
            color: var(--danger-color);
        }

        .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            transition: background 0.2s;
            user-select: none;
        }

        .history-item:hover {
            background: var(--bg-hover);
        }

        .history-item.selected {
            background: var(--primary-color);
            color: white;
        }

        .history-item.dragging {
            opacity: 0.5;
            background: var(--bg-secondary);
        }

        .history-item.drag-over {
            border-top: 2px solid var(--primary-color);
        }

        .history-method {
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .history-url {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .history-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .environment-panel {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .environment-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .variables-table {
            width: 100%;
            border-collapse: collapse;
        }

        .variables-table th,
        .variables-table td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .variables-table th {
            background: var(--bg-secondary);
            font-weight: 500;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: 0.75rem;
            background: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
            transition: all 0.2s;
        }

        .sidebar-tab.active {
            background: var(--bg-color);
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .success-message {
            color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .code-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 200px;
            resize: vertical;
        }

        .preview-html {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 1rem;
            background: white;
            min-height: 200px;
        }

        .preview-html iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toolbar-btn {
            padding: 0.25rem 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color);
        }

        .close {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: var(--text-color);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
        }

        @media (max-width: 768px) {
            .postman-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr;
            }

            .postman-sidebar {
                display: none;
            }

            .request-tabs {
                flex-wrap: wrap;
            }

            .request-tab {
                flex: 1;
                min-width: 80px;
            }
        }

        /* å¯æ‹–æ‹½åˆ†éš”çº¿æ ·å¼ */
        .resizable-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .resizing {
            cursor: row-resize !important;
        }

        .resizing * {
            cursor: row-resize !important;
            user-select: none;
        }

        /* ç¡®ä¿å†…å®¹åŒºåŸŸå¯ä»¥æ»šåŠ¨ */
        .request-section .tab-content,
        .response-section .tab-content {
            height: calc(100% - 50px); /* å‡å»æ ‡ç­¾é¡µé«˜åº¦ */
            overflow-y: auto;
        }

        /* å“åº”å†…å®¹åŒºåŸŸæ ·å¼ */
        .response-content {
            height: calc(100% - 50px); /* å‡å»æ ‡ç­¾é¡µé«˜åº¦ */
            overflow: hidden;
        }

        .response-content .tab-content {
            height: 100%;
            overflow-y: auto;
        }

        /* ç¡®ä¿æ–‡æœ¬åŒºåŸŸå¯ä»¥æ­£ç¡®è°ƒæ•´å¤§å° */
        .code-editor {
            height: calc(100% - 60px); /* å‡å»å·¥å…·æ é«˜åº¦ */
            resize: none;
        }
    </style>
</head>
<body>
    {{template "nav" .}}
    
    <main class="container">
      
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="alert alert-info" style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 4px;">
            <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-color);">
                <li><strong>æœ¬åœ°æµ‹è¯•</strong>: å¯ä»¥ç›´æ¥æµ‹è¯• localhost æœåŠ¡ï¼Œå¦‚ <code>http://localhost:3000/api/users</code></li>
                <li><strong>ç¯å¢ƒå˜é‡</strong>: ä½¿ç”¨ <code>&#123;&#123;å˜é‡å&#125;&#125;</code> æ ¼å¼ï¼Œå¦‚ <code>&#123;&#123;baseUrl&#125;&#125;/posts</code></li>
                <li><strong>è¯·æ±‚å†å²</strong>: æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•ä¸­</li>
                <li><strong>å“åº”é¢„è§ˆ</strong>: æ”¯æŒ JSONã€HTML ç­‰æ ¼å¼çš„å“åº”é¢„è§ˆ</li>
            </ul>
        </div>

        <div class="postman-container">
            <!-- å¤´éƒ¨ -->
            <div class="postman-header">
                <select id="methodSelect" class="method-select">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                    <option value="PATCH">PATCH</option>
                    <option value="HEAD">HEAD</option>
                    <option value="OPTIONS">OPTIONS</option>
                </select>
                <input type="text" id="urlInput" class="form-control url-input" placeholder="è¾“å…¥è¯·æ±‚ URL...">
                <button id="sendBtn" class="send-btn">
                    <span id="sendText">å‘é€</span>
                    <span id="sendLoading" class="loading" style="display: none;"></span>
                </button>
                <button id="importCurlBtn" class="toolbar-btn" style="margin-left: 0.5rem;" onclick="showImportCurlModal()">
                    <span class="material-icons" style="font-size: 16px; margin-right: 4px;">file_upload</span>
                    å¯¼å…¥ curl
                </button>
            </div>

            <!-- curl å¯¼å…¥æ¨¡æ€æ¡† -->
            <div id="importCurlModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>å¯¼å…¥ curl å‘½ä»¤</h3>
                        <span class="close" onclick="hideImportCurlModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="curlCommandTextarea">ç²˜è´´ curl å‘½ä»¤:</label>
                            <textarea id="curlCommandTextarea" class="form-control code-editor" rows="8" 
                                placeholder="ä¾‹å¦‚: curl -X POST https://api.example.com/users -H 'Content-Type: application/json' -d '{&quot;name&quot;:&quot;John&quot;}'"></textarea>
                        </div>
                        <div class="form-group">
                            <label>æ”¯æŒçš„ curl é€‰é¡¹:</label>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                <code>-X, --request</code> (HTTP æ–¹æ³•) | 
                                <code>-H, --header</code> (è¯·æ±‚å¤´) | 
                                <code>-d, --data</code> (è¯·æ±‚ä½“) | 
                                <code>-u, --user</code> (åŸºæœ¬è®¤è¯) | 
                                <code>--connect-timeout</code> (è¶…æ—¶æ—¶é—´)
                            </div>
                        </div>
                        <div id="curlError" class="error-message" style="display: none;"></div>
                        <div id="curlSuccess" class="success-message" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="hideImportCurlModal()">å–æ¶ˆ</button>
                        <button class="btn btn-primary" onclick="importCurl()">å¯¼å…¥</button>
                    </div>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="postman-sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="history">å†å²</button>
                    <button class="sidebar-tab" data-tab="environment">ç¯å¢ƒ</button>
                </div>
                
                <div class="sidebar-content">
                    <!-- å†å²è®°å½• -->
                    <div id="historyTab" class="tab-content active">
                        <div class="toolbar">
                            <button class="toolbar-btn" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
                        </div>
                        <div id="historyList"></div>
                    </div>

                    <!-- ç¯å¢ƒå˜é‡ -->
                    <div id="environmentTab" class="tab-content">
                        <div class="environment-panel">
                            <select id="environmentSelect" class="environment-select">
                                <option value="default">é»˜è®¤ç¯å¢ƒ</option>
                            </select>
                            <button class="toolbar-btn" onclick="createEnvironment()">æ–°å»ºç¯å¢ƒ</button>
                            <button class="toolbar-btn" onclick="editEnvironment()">ç¼–è¾‘ç¯å¢ƒ</button>
                            <button class="toolbar-btn" onclick="addVariable()">æ·»åŠ å˜é‡</button>
                        </div>
                        <div id="variablesList"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="postman-main">
                <!-- å¯æ‹–æ‹½å®¹å™¨ -->
                <div class="resizable-container">
                    <!-- è¯·æ±‚åŒºåŸŸ -->
                    <div class="request-section">
                        <!-- è¯·æ±‚æ ‡ç­¾é¡µ -->
                        <div class="request-tabs">
                            <button class="request-tab active" data-tab="headers">è¯·æ±‚å¤´</button>
                            <button class="request-tab" data-tab="body">è¯·æ±‚ä½“</button>
                            <button class="request-tab" data-tab="params">å‚æ•°</button>
                        </div>

                        <!-- è¯·æ±‚å†…å®¹ -->
                        <div class="tab-content active" id="headersTab">
                            <table class="headers-table">
                                <thead>
                                    <tr>
                                        <th>é”®</th>
                                        <th>å€¼</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="headersTableBody">
                                    <tr>
                                        <td><input type="text" class="form-control" placeholder="é”®å"></td>
                                        <td><input type="text" class="form-control" placeholder="å€¼"></td>
                                        <td><button class="remove-header-btn" onclick="removeHeader(this)">åˆ é™¤</button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="add-header-btn" onclick="addHeader()">æ·»åŠ è¯·æ±‚å¤´</button>
                        </div>

                        <div class="tab-content" id="bodyTab">
                            <div class="form-group">
                                <label>Content-Type:</label>
                                <select id="contentTypeSelect" class="form-control">
                                    <option value="application/json">application/json</option>
                                    <option value="application/x-www-form-urlencoded">application/x-www-form-urlencoded</option>
                                    <option value="text/plain">text/plain</option>
                                    <option value="text/xml">text/xml</option>
                                    <option value="multipart/form-data">multipart/form-data</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>è¯·æ±‚ä½“:</label>
                                <textarea id="bodyTextarea" class="form-control code-editor" placeholder="è¾“å…¥è¯·æ±‚ä½“å†…å®¹..."></textarea>
                            </div>
                            <div class="toolbar">
                                <button class="toolbar-btn" onclick="formatBody()">æ ¼å¼åŒ–</button>
                                <button class="toolbar-btn" onclick="clearBody()">æ¸…ç©º</button>
                            </div>
                        </div>

                        <div class="tab-content" id="paramsTab">
                            <table class="headers-table">
                                <thead>
                                    <tr>
                                        <th>å‚æ•°å</th>
                                        <th>å€¼</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="paramsTableBody">
                                    <tr>
                                        <td><input type="text" class="form-control" placeholder="å‚æ•°å"></td>
                                        <td><input type="text" class="form-control" placeholder="å€¼"></td>
                                        <td><button class="remove-header-btn" onclick="removeParam(this)">åˆ é™¤</button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="add-header-btn" onclick="addParam()">æ·»åŠ å‚æ•°</button>
                        </div>
                    </div>

                    <!-- å¯æ‹–æ‹½åˆ†éš”çº¿ -->
                    <div class="resize-handle" id="resizeHandle"></div>

                    <!-- å“åº”åŒºåŸŸ -->
                    <div class="response-section">
                        <div class="response-container">
                            <div class="response-tabs">
                                <button class="response-tab active" data-tab="response">å“åº”</button>
                                <button class="response-tab" data-tab="responseHeaders">å“åº”å¤´</button>
                                <button class="response-tab" data-tab="preview">é¢„è§ˆ</button>
                            </div>

                            <div class="response-content">
                              
                                
                                <div id="responseTab" class="tab-content active">
                                    <div id="responseInfo" class="response-info" style="display: none;"></div>
                                    <textarea id="responseTextarea" class="form-control code-editor" readonly></textarea>
                                </div>

                                <div id="responseHeadersTab" class="tab-content">
                                    <div id="responseHeaders"></div>
                                </div>

                                <div id="previewTab" class="tab-content">
                                    <div id="previewContent" class="preview-html"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

   
    <script>
        let currentEnvironment = 'default';
        let environments = {};
        let history = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadEnvironments();
            loadHistory();
            setupEventListeners();
            
            // æ·»åŠ ä¸€äº›æµ‹è¯•ç”¨çš„ç¯å¢ƒå˜é‡
            addTestVariables();
        });

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // è¯·æ±‚æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.request-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchRequestTab(tabName);
                });
            });

            // å“åº”æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.response-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchResponseTab(tabName);
                });
            });

            // ä¾§è¾¹æ æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchSidebarTab(tabName);
                });
            });

            // å‘é€æŒ‰é’®
            document.getElementById('sendBtn').addEventListener('click', sendRequest);

            // URL è¾“å…¥æ¡†å›è½¦
            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendRequest();
                }
            });

            // ç¯å¢ƒé€‰æ‹©
            document.getElementById('environmentSelect').addEventListener('change', function() {
                currentEnvironment = this.value;
                loadVariables();
            });

            // æ‹–æ‹½åˆ†éš”çº¿
            setupResizeHandle();
        }

        // åˆ‡æ¢è¯·æ±‚æ ‡ç­¾é¡µ
        function switchRequestTab(tabName) {
            document.querySelectorAll('.request-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // åˆ‡æ¢å“åº”æ ‡ç­¾é¡µ
        function switchResponseTab(tabName) {
            document.querySelectorAll('.response-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.response-content .tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.response-tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // åˆ‡æ¢ä¾§è¾¹æ æ ‡ç­¾é¡µ
        function switchSidebarTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.sidebar-content .tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.sidebar-tab[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // å‘é€è¯·æ±‚
        async function sendRequest() {
            const method = document.getElementById('methodSelect').value;
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showError('è¯·è¾“å…¥è¯·æ±‚ URL');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const sendBtn = document.getElementById('sendBtn');
            const sendText = document.getElementById('sendText');
            const sendLoading = document.getElementById('sendLoading');
            
            sendBtn.disabled = true;
            sendText.style.display = 'none';
            sendLoading.style.display = 'inline-block';

            try {
                // æ”¶é›†è¯·æ±‚å¤´
                const headers = {};
                document.querySelectorAll('#headersTableBody tr').forEach(row => {
                    const key = row.querySelector('td:first-child input').value.trim();
                    const value = row.querySelector('td:nth-child(2) input').value.trim();
                    if (key && value) {
                        headers[key] = value;
                    }
                });

                // æ”¶é›†è¯·æ±‚ä½“
                const body = document.getElementById('bodyTextarea').value;
                const contentType = document.getElementById('contentTypeSelect').value;

                // å¤„ç†ç¯å¢ƒå˜é‡
                const processedUrl = processEnvironmentVariables(url);
                const processedHeaders = {};
                for (const [key, value] of Object.entries(headers)) {
                    processedHeaders[key] = processEnvironmentVariables(value);
                }
                const processedBody = processEnvironmentVariables(body);

                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData = {
                    method: method,
                    url: processedUrl,
                    headers: processedHeaders,
                    body: processedBody,
                    contentType: contentType,
                    timeout: 30
                };

                // åœ¨æµè§ˆå™¨ç«¯ç›´æ¥å‘é€è¯·æ±‚
                const startTime = Date.now();
                const response = await sendHttpRequest(requestData);
                const responseTime = Date.now() - startTime;

                // æ„å»ºå“åº”æ•°æ®
                const responseData = {
                    request: requestData,
                    response: {
                        statusCode: response.status,
                        statusText: response.statusText,
                        headers: response.headers,
                        body: response.body,
                        contentType: response.contentType,
                        contentLength: response.body.length,
                        time: responseTime,
                        size: response.body.length
                    }
                };

                displayResponse(responseData);
                showSuccess('è¯·æ±‚å‘é€æˆåŠŸ');

                // ä¿å­˜åˆ°å†å²è®°å½•
                saveToHistory(responseData);

            } catch (error) {
                showError('è¯·æ±‚å‘é€å¤±è´¥: ' + error.message);
                
                // ä¿å­˜é”™è¯¯åˆ°å†å²è®°å½•
                const requestData = {
                    method: method,
                    url: url,
                    headers: headers,
                    body: body,
                    contentType: contentType,
                    timeout: 30
                };
                saveToHistory({
                    request: requestData,
                    error: error.message
                });
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                sendBtn.disabled = false;
                sendText.style.display = 'inline';
                sendLoading.style.display = 'none';
            }
        }

        // åœ¨æµè§ˆå™¨ç«¯å‘é€ HTTP è¯·æ±‚
        async function sendHttpRequest(requestData) {
            const { method, url, headers, body, timeout } = requestData;
            
            // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout * 1000);

            try {
                // å‡†å¤‡è¯·æ±‚é€‰é¡¹
                const options = {
                    method: method,
                    headers: headers,
                    signal: controller.signal
                };

                // æ·»åŠ è¯·æ±‚ä½“ï¼ˆå¦‚æœæœ‰ï¼‰
                if (body && method !== 'GET' && method !== 'HEAD') {
                    options.body = body;
                }

                // å‘é€è¯·æ±‚
                const response = await fetch(url, options);
                clearTimeout(timeoutId);

                // è¯»å–å“åº”ä½“
                let responseBody = '';
                let contentType = '';
                
                try {
                    responseBody = await response.text();
                    contentType = response.headers.get('content-type') || 'text/plain';
                } catch (e) {
                    responseBody = 'æ— æ³•è¯»å–å“åº”ä½“: ' + e.message;
                    contentType = 'text/plain';
                }

                // æ„å»ºå“åº”å¤´å¯¹è±¡
                const responseHeaders = {};
                response.headers.forEach((value, key) => {
                    responseHeaders[key] = value;
                });

                return {
                    status: response.status,
                    statusText: response.statusText,
                    headers: responseHeaders,
                    body: responseBody,
                    contentType: contentType
                };

            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶');
                }
                throw error;
            }
        }

        // å¤„ç†ç¯å¢ƒå˜é‡
        function processEnvironmentVariables(input) {
            if (!input) return input;
            
            const env = environments[currentEnvironment];
            if (!env) return input;

            let result = input;
            for (const variable of env.variables) {
                // é¿å… Go æ¨¡æ¿è§£æï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
                const placeholder = '{' + '{' + variable.key + '}' + '}';
                result = result.replace(new RegExp(placeholder, 'g'), variable.value);
            }
            return result;
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        async function saveToHistory(data) {
            try {
                const historyItem = {
                    id: Date.now().toString(),
                    name: `${data.request.method} ${new URL(data.request.url).hostname}`,
                    request: data.request,
                    response: data.response,
                    timestamp: new Date().toISOString(),
                    status: data.error ? 'error' : 'success',
                    error: data.error
                };

                // å‘é€åˆ°åç«¯ä¿å­˜
                await fetch('/tools/api/postman/history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(historyItem)
                });

                // æ›´æ–°æœ¬åœ°å†å²è®°å½•
                history.unshift(historyItem);
                if (history.length > 100) {
                    history = history.slice(0, 100);
                }
                displayHistory();

            } catch (error) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå“åº”
        function displayResponse(data) {
            const response = data.response;
            
            // æ˜¾ç¤ºå“åº”ä¿¡æ¯
            const responseInfo = document.getElementById('responseInfo');
            responseInfo.innerHTML = `
                <div class="info-item">
                    <div class="info-label">çŠ¶æ€ç </div>
                    <div class="info-value status-${response.statusCode >= 200 && response.statusCode < 300 ? 'success' : 'error'}">${response.statusCode} ${response.statusText}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å“åº”æ—¶é—´</div>
                    <div class="info-value">${response.time}ms</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å“åº”å¤§å°</div>
                    <div class="info-value">${formatBytes(response.size)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Content-Type</div>
                    <div class="info-value">${response.contentType || 'text/plain'}</div>
                </div>
            `;
            responseInfo.style.display = 'grid';

            // æ˜¾ç¤ºå“åº”ä½“
            document.getElementById('responseTextarea').value = response.body;

            // æ˜¾ç¤ºå“åº”å¤´
            const responseHeaders = document.getElementById('responseHeadersTab');
            let headersHtml = '<table class="headers-table"><thead><tr><th>é”®</th><th>å€¼</th></tr></thead><tbody>';
            
            // ä½¿ç”¨ Headers.entries() æ¥æ­£ç¡®éå†
            if (response.headers && typeof response.headers.entries === 'function') {
                 for (const [key, value] of response.headers.entries()) {
                    headersHtml += `<tr><td>${escapeHtml(key)}</td><td>${escapeHtml(value)}</td></tr>`;
                }
            } else if (response.headers) { // å…¼å®¹æ™®é€šå¯¹è±¡
                 for (const [key, value] of Object.entries(response.headers)) {
                    headersHtml += `<tr><td>${escapeHtml(key)}</td><td>${escapeHtml(value)}</td></tr>`;
                }
            }
           
            headersHtml += '</tbody></table>';
            responseHeaders.innerHTML = headersHtml;

            // æ˜¾ç¤ºé¢„è§ˆ
            const previewContent = document.getElementById('previewContent');
            if (response.contentType && response.contentType.includes('text/html')) {
                previewContent.innerHTML = `<iframe srcdoc="${escapeHtml(response.body)}"></iframe>`;
            } else if (response.contentType && response.contentType.includes('application/json')) {
                try {
                    const formatted = JSON.stringify(JSON.parse(response.body), null, 2);
                    previewContent.innerHTML = `<pre>${escapeHtml(formatted)}</pre>`;
                } catch (e) {
                    previewContent.innerHTML = `<pre>${escapeHtml(response.body)}</pre>`;
                }
            } else {
                previewContent.innerHTML = `<pre>${escapeHtml(response.body)}</pre>`;
            }
        }

        // åŠ è½½ç¯å¢ƒ
        async function loadEnvironments() {
            try {
                console.log('å¼€å§‹åŠ è½½ç¯å¢ƒ...');
                const response = await fetch('/tools/api/postman/environments');
                const result = await response.json();
                
                console.log('ç¯å¢ƒåŠ è½½ç»“æœ:', result);
                
                if (result.success) {
                    environments = {};
                    const select = document.getElementById('environmentSelect');
                    select.innerHTML = '';
                    
                    result.data.forEach(env => {
                        environments[env.id] = env;
                        const option = document.createElement('option');
                        option.value = env.id;
                        option.textContent = env.name;
                        select.appendChild(option);
                    });
                    
                    console.log('åŠ è½½çš„ç¯å¢ƒ:', environments);
                    loadVariables();
                } else {
                    console.error('ç¯å¢ƒåŠ è½½å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('åŠ è½½ç¯å¢ƒå¤±è´¥:', error);
            }
        }

        // åŠ è½½å˜é‡
        function loadVariables() {
            const env = environments[currentEnvironment];
            if (!env) {
                console.warn('å½“å‰ç¯å¢ƒä¸å­˜åœ¨:', currentEnvironment);
                return;
            }

            const variablesList = document.getElementById('variablesList');
            if (!variablesList) {
                console.error('æ‰¾ä¸åˆ° variablesList å…ƒç´ ');
                return;
            }

            let html = '<table class="variables-table"><thead><tr><th>é”®</th><th>å€¼</th><th>ç±»å‹</th><th>æ“ä½œ</th></tr></thead><tbody>';
            
            if (env.variables && env.variables.length > 0) {
                env.variables.forEach(variable => {
                    html += `
                        <tr>
                            <td>${escapeHtml(variable.key)}</td>
                            <td>${escapeHtml(variable.value)}</td>
                            <td>${escapeHtml(variable.type || 'string')}</td>
                            <td>
                                <button class="toolbar-btn" onclick="editVariable('${escapeHtml(variable.key)}')" title="ç¼–è¾‘å˜é‡">ç¼–è¾‘</button>
                                <button class="toolbar-btn" onclick="deleteVariable('${escapeHtml(variable.key)}')" title="åˆ é™¤å˜é‡">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">æš‚æ— å˜é‡</td></tr>';
            }
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 1rem;"><button class="add-header-btn" onclick="addVariable()" style="width: 100%;">æ·»åŠ å˜é‡</button></div>';
            variablesList.innerHTML = html;
        }

        // åŠ è½½å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/tools/api/postman/history');
                const result = await response.json();
                
                if (result.success) {
                    history = result.data;
                    displayHistory();
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå†å²
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            let html = '';
            
            history.forEach(item => {
                const time = new Date(item.timestamp).toLocaleString();
                html += `
                    <div class="history-item" onclick="loadHistoryItem('${item.id}')">
                        <div>
                            <span class="history-method">${item.request.method}</span>
                            <span class="history-url">${item.request.url}</span>
                        </div>
                        <div class="history-time">${time}</div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // åŠ è½½å†å²é¡¹
        function loadHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;

            document.getElementById('methodSelect').value = item.request.method;
            document.getElementById('urlInput').value = item.request.url;
            document.getElementById('bodyTextarea').value = item.request.body || '';
            document.getElementById('contentTypeSelect').value = item.request.contentType || 'application/json';

            // åŠ è½½è¯·æ±‚å¤´
            const headersTableBody = document.getElementById('headersTableBody');
            headersTableBody.innerHTML = '';
            for (const [key, value] of Object.entries(item.request.headers)) {
                addHeaderRow(key, value);
            }
            addHeaderRow('', ''); // æ·»åŠ ç©ºè¡Œ
        }

        // æ¸…ç©ºå†å²
        async function clearHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) return;

            try {
                const response = await fetch('/tools/api/postman/history', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    history = [];
                    displayHistory();
                    showSuccess('å†å²è®°å½•å·²æ¸…ç©º');
                }
            } catch (error) {
                showError('æ¸…ç©ºå†å²å¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ è¯·æ±‚å¤´
        function addHeader() {
            addHeaderRow('', '');
        }

        // æ·»åŠ è¯·æ±‚å¤´è¡Œ
        function addHeaderRow(key = '', value = '') {
            const tbody = document.getElementById('headersTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control" value="${key}" placeholder="é”®å"></td>
                <td><input type="text" class="form-control" value="${value}" placeholder="å€¼"></td>
                <td><button class="remove-header-btn" onclick="removeHeader(this)">åˆ é™¤</button></td>
            `;
            tbody.appendChild(row);
        }

        // åˆ é™¤è¯·æ±‚å¤´
        function removeHeader(btn) {
            const row = btn.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
            }
        }

        // æ·»åŠ å‚æ•°
        function addParam() {
            addParamRow('', '');
        }

        // æ·»åŠ å‚æ•°è¡Œ
        function addParamRow(key = '', value = '') {
            const tbody = document.getElementById('paramsTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="form-control" value="${key}" placeholder="å‚æ•°å"></td>
                <td><input type="text" class="form-control" value="${value}" placeholder="å€¼"></td>
                <td><button class="remove-header-btn" onclick="removeParam(this)">åˆ é™¤</button></td>
            `;
            tbody.appendChild(row);
        }

        // åˆ é™¤å‚æ•°
        function removeParam(btn) {
            const row = btn.closest('tr');
            const tbody = row.parentNode;
            if (tbody.children.length > 1) {
                row.remove();
            }
        }

        // æ ¼å¼åŒ–è¯·æ±‚ä½“
        function formatBody() {
            const textarea = document.getElementById('bodyTextarea');
            const contentType = document.getElementById('contentTypeSelect').value;
            
            if (contentType === 'application/json') {
                try {
                    const formatted = JSON.stringify(JSON.parse(textarea.value), null, 2);
                    textarea.value = formatted;
                } catch (e) {
                    showError('JSON æ ¼å¼é”™è¯¯');
                }
            }
        }

        // æ¸…ç©ºè¯·æ±‚ä½“
        function clearBody() {
            document.getElementById('bodyTextarea').value = '';
        }

        // æ ¼å¼åŒ–å“åº”
        function formatResponse() {
            const textarea = document.getElementById('responseTextarea');
            const contentType = document.querySelector('.response-info .info-value:last-child').textContent;
            
            if (contentType.includes('application/json')) {
                try {
                    const formatted = JSON.stringify(JSON.parse(textarea.value), null, 2);
                    textarea.value = formatted;
                } catch (e) {
                    showError('JSON æ ¼å¼é”™è¯¯');
                }
            }
        }

        // å¤åˆ¶å“åº”
        function copyResponse() {
            const textarea = document.getElementById('responseTextarea');
            textarea.select();
            document.execCommand('copy');
            showSuccess('å“åº”å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        // åˆ›å»ºç¯å¢ƒ
        async function createEnvironment() {
            const name = prompt('è¯·è¾“å…¥ç¯å¢ƒåç§°:');
            if (!name) return;

            try {
                const response = await fetch('/tools/api/postman/environments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadEnvironments();
                    showSuccess('ç¯å¢ƒåˆ›å»ºæˆåŠŸ');
                } else {
                    showError(result.error || 'ç¯å¢ƒåˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                showError('ç¯å¢ƒåˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘ç¯å¢ƒ
        async function editEnvironment() {
            const env = environments[currentEnvironment];
            if (!env) return;

            const name = prompt('è¯·è¾“å…¥ç¯å¢ƒåç§°:', env.name);
            if (name === null) return;

            try {
                const response = await fetch(`/tools/api/postman/environments/${env.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        variables: env.variables
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    await loadEnvironments();
                    showSuccess('ç¯å¢ƒæ›´æ–°æˆåŠŸ');
                } else {
                    showError(result.error || 'ç¯å¢ƒæ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                showError('ç¯å¢ƒæ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // æ·»åŠ å˜é‡
        async function addVariable() {
            const key = prompt('è¯·è¾“å…¥å˜é‡å:');
            if (!key || key.trim() === '') {
                showError('å˜é‡åä¸èƒ½ä¸ºç©º');
                return;
            }
            
            const value = prompt('è¯·è¾“å…¥å˜é‡å€¼:');
            if (value === null) return; // ç”¨æˆ·å–æ¶ˆ

            const env = environments[currentEnvironment];
            if (!env) {
                showError('å½“å‰ç¯å¢ƒä¸å­˜åœ¨');
                return;
            }

            // æ£€æŸ¥å˜é‡åæ˜¯å¦å·²å­˜åœ¨
            if (env.variables && env.variables.find(v => v.key === key.trim())) {
                showError('å˜é‡åå·²å­˜åœ¨');
                return;
            }

            const newVariable = {
                key: key.trim(),
                value: value,
                type: 'string'
            };

            // ç¡®ä¿ variables æ•°ç»„å­˜åœ¨
            if (!env.variables) {
                env.variables = [];
            }

            env.variables.push(newVariable);

            try {
                const response = await fetch(`/tools/api/postman/environments/${env.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: env.name,
                        variables: env.variables
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    loadVariables();
                    showSuccess('å˜é‡æ·»åŠ æˆåŠŸ');
                } else {
                    showError(result.error || 'å˜é‡æ·»åŠ å¤±è´¥');
                    // å›æ»šæœ¬åœ°æ›´æ”¹
                    env.variables.pop();
                }
            } catch (error) {
                showError('å˜é‡æ·»åŠ å¤±è´¥: ' + error.message);
                // å›æ»šæœ¬åœ°æ›´æ”¹
                env.variables.pop();
            }
        }

        // ç¼–è¾‘å˜é‡
        async function editVariable(key) {
            const env = environments[currentEnvironment];
            if (!env) {
                showError('å½“å‰ç¯å¢ƒä¸å­˜åœ¨');
                return;
            }

            const variable = env.variables.find(v => v.key === key);
            if (!variable) {
                showError('å˜é‡ä¸å­˜åœ¨');
                return;
            }

            const value = prompt(`ç¼–è¾‘å˜é‡ ${key}:`, variable.value);
            if (value === null) return; // ç”¨æˆ·å–æ¶ˆ

            // ä¿å­˜åŸå§‹å€¼ç”¨äºå›æ»š
            const originalValue = variable.value;
            variable.value = value;

            try {
                const response = await fetch(`/tools/api/postman/environments/${env.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: env.name,
                        variables: env.variables
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    loadVariables();
                    showSuccess('å˜é‡æ›´æ–°æˆåŠŸ');
                } else {
                    showError(result.error || 'å˜é‡æ›´æ–°å¤±è´¥');
                    // å›æ»šæœ¬åœ°æ›´æ”¹
                    variable.value = originalValue;
                }
            } catch (error) {
                showError('å˜é‡æ›´æ–°å¤±è´¥: ' + error.message);
                // å›æ»šæœ¬åœ°æ›´æ”¹
                variable.value = originalValue;
            }
        }

        // åˆ é™¤å˜é‡
        async function deleteVariable(key) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å˜é‡ ${key} å—ï¼Ÿ`)) return;

            const env = environments[currentEnvironment];
            if (!env) {
                showError('å½“å‰ç¯å¢ƒä¸å­˜åœ¨');
                return;
            }

            const variable = env.variables.find(v => v.key === key);
            if (!variable) {
                showError('å˜é‡ä¸å­˜åœ¨');
                return;
            }

            // ä¿å­˜åŸå§‹å˜é‡æ•°ç»„ç”¨äºå›æ»š
            const originalVariables = [...env.variables];
            env.variables = env.variables.filter(v => v.key !== key);

            try {
                const response = await fetch(`/tools/api/postman/environments/${env.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: env.name,
                        variables: env.variables
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    loadVariables();
                    showSuccess('å˜é‡åˆ é™¤æˆåŠŸ');
                } else {
                    showError(result.error || 'å˜é‡åˆ é™¤å¤±è´¥');
                    // å›æ»šæœ¬åœ°æ›´æ”¹
                    env.variables = originalVariables;
                }
            } catch (error) {
                showError('å˜é‡åˆ é™¤å¤±è´¥: ' + error.message);
                // å›æ»šæœ¬åœ°æ›´æ”¹
                env.variables = originalVariables;
            }
        }

        // æ·»åŠ æµ‹è¯•ç”¨çš„ç¯å¢ƒå˜é‡
        async function addTestVariables() {
            const env = environments['default'];
            if (!env || env.variables.length > 0) return;

            const testVariables = [
                { key: 'baseUrl', value: 'https://jsonplaceholder.typicode.com', type: 'string' },
                { key: 'apiKey', value: 'your-api-key-here', type: 'string' },
                { key: 'userId', value: '1', type: 'number' }
            ];

            env.variables = testVariables;

            try {
                const response = await fetch(`/tools/api/postman/environments/${env.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: env.name,
                        variables: env.variables
                    })
                });

                if (response.ok) {
                    loadVariables();
                }
            } catch (error) {
                console.error('æ·»åŠ æµ‹è¯•å˜é‡å¤±è´¥:', error);
            }
        }

        // å·¥å…·å‡½æ•°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1001';
            successDiv.style.minWidth = '300px';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '1001';
            errorDiv.style.minWidth = '300px';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // curl å¯¼å…¥ç›¸å…³å‡½æ•°
        function showImportCurlModal() {
            document.getElementById('importCurlModal').style.display = 'flex';
            document.getElementById('curlCommandTextarea').focus();
        }

        function hideImportCurlModal() {
            document.getElementById('importCurlModal').style.display = 'none';
            document.getElementById('curlCommandTextarea').value = '';
            document.getElementById('curlError').style.display = 'none';
            document.getElementById('curlSuccess').style.display = 'none';
        }

        async function importCurl() {
            const curlCommand = document.getElementById('curlCommandTextarea').value.trim();
            if (!curlCommand) {
                showCurlError('è¯·è¾“å…¥ curl å‘½ä»¤');
                return;
            }

            // å¤„ç† curl å‘½ä»¤æ ¼å¼
            const processedCommand = curlCommand
                .replace(/\\\n/g, ' ')  // æ›¿æ¢ç»­è¡Œç¬¦ä¸ºç©ºæ ¼
                .replace(/\s+/g, ' ')   // å¤šä¸ªç©ºæ ¼æ›¿æ¢ä¸ºå•ä¸ªç©ºæ ¼
                .trim();                // å»é™¤é¦–å°¾ç©ºæ ¼

            try {
                const response = await fetch('/tools/api/postman/import-curl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        curlCommand: processedCommand
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // å¡«å……è¡¨å•
                    fillRequestFromCurl(result.data);
                    showCurlSuccess('curl å‘½ä»¤å¯¼å…¥æˆåŠŸ');
                    hideImportCurlModal();
                } else {
                    showCurlError(result.error || 'å¯¼å…¥å¤±è´¥');
                }
            } catch (error) {
                showCurlError('å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }

        function fillRequestFromCurl(httpRequest) {
            console.log('å¡«å……è¯·æ±‚è¡¨å•:', httpRequest);
            
            // è®¾ç½® HTTP æ–¹æ³•
            document.getElementById('methodSelect').value = httpRequest.method;
            console.log('è®¾ç½®æ–¹æ³•:', httpRequest.method);
            
            // è®¾ç½® URL
            document.getElementById('urlInput').value = httpRequest.url;
            console.log('è®¾ç½® URL:', httpRequest.url);
            
            // è®¾ç½®è¯·æ±‚å¤´
            const headersTableBody = document.getElementById('headersTableBody');
            headersTableBody.innerHTML = '';
            
            console.log('è®¾ç½®è¯·æ±‚å¤´:', httpRequest.headers);
            for (const [key, value] of Object.entries(httpRequest.headers)) {
                addHeaderRow(key, value);
            }
            
            // å¦‚æœæ²¡æœ‰è¯·æ±‚å¤´ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¡Œ
            if (Object.keys(httpRequest.headers).length === 0) {
                addHeaderRow();
            }
            
            // è®¾ç½®è¯·æ±‚ä½“
            if (httpRequest.body) {
                document.getElementById('bodyTextarea').value = httpRequest.body;
                console.log('è®¾ç½®è¯·æ±‚ä½“:', httpRequest.body);
                
                // è®¾ç½® Content-Type
                if (httpRequest.contentType) {
                    document.getElementById('contentTypeSelect').value = httpRequest.contentType;
                    console.log('è®¾ç½® Content-Type:', httpRequest.contentType);
                }
                
                // åˆ‡æ¢åˆ°è¯·æ±‚ä½“æ ‡ç­¾é¡µ
                switchRequestTab('body');
            }
            
            // è®¾ç½®è¶…æ—¶
            if (httpRequest.timeout) {
                console.log('è¶…æ—¶è®¾ç½®:', httpRequest.timeout);
            }
        }

        function showCurlError(message) {
            const errorDiv = document.getElementById('curlError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('curlSuccess').style.display = 'none';
        }

        function showCurlSuccess(message) {
            const successDiv = document.getElementById('curlSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('curlError').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('importCurlModal');
            if (event.target === modal) {
                hideImportCurlModal();
            }
        }

        // è®¾ç½®æ‹–æ‹½åˆ†éš”çº¿
        function setupResizeHandle() {
            console.log('å¼€å§‹è®¾ç½®æ‹–æ‹½åˆ†éš”çº¿...');
            
            const resizeHandle = document.getElementById('resizeHandle');
            const container = document.querySelector('.resizable-container');
            const requestSection = document.querySelector('.request-section');
            const responseSection = document.querySelector('.response-section');
            
            console.log('æ‹–æ‹½å…ƒç´ æ£€æŸ¥:', {
                resizeHandle: !!resizeHandle,
                container: !!container,
                requestSection: !!requestSection,
                responseSection: !!responseSection
            });
            
            if (!resizeHandle || !container || !requestSection || !responseSection) {
                console.error('æ‹–æ‹½å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            console.log('æ‰€æœ‰æ‹–æ‹½å…ƒç´ å·²æ‰¾åˆ°ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶...');

            let isResizing = false;
            let startY = 0;
            let startRequestHeight = 0;
            let startResponseHeight = 0;

            // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
            resizeHandle.addEventListener('mousedown', function(e) {
                console.log('é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶è§¦å‘:', {
                    clientY: e.clientY,
                    target: e.target,
                    isResizing: isResizing
                });
                
                isResizing = true;
                startY = e.clientY;
                startRequestHeight = requestSection.offsetHeight;
                startResponseHeight = responseSection.offsetHeight;
                
                console.log('æ‹–æ‹½å¼€å§‹ï¼Œåˆå§‹çŠ¶æ€:', {
                    startY: startY,
                    startRequestHeight: startRequestHeight,
                    startResponseHeight: startResponseHeight
                });
                
                document.body.classList.add('resizing');
                e.preventDefault();
            });

            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const deltaY = e.clientY - startY;
                const containerHeight = container.offsetHeight;
                const handleHeight = resizeHandle.offsetHeight;
                const minHeight = 150; // æœ€å°é«˜åº¦

                console.log('é¼ æ ‡ç§»åŠ¨ï¼Œè®¡ç®—æ–°å°ºå¯¸:', {
                    currentY: e.clientY,
                    deltaY: deltaY,
                    containerHeight: containerHeight,
                    handleHeight: handleHeight
                });

                // è®¡ç®—æ–°çš„é«˜åº¦
                let newRequestHeight = startRequestHeight + deltaY;
                let newResponseHeight = startResponseHeight - deltaY;

                console.log('è®¡ç®—çš„é«˜åº¦:', {
                    newRequestHeight: newRequestHeight,
                    newResponseHeight: newResponseHeight
                });

                // ç¡®ä¿æœ€å°é«˜åº¦
                if (newRequestHeight < minHeight) {
                    newRequestHeight = minHeight;
                    newResponseHeight = containerHeight - minHeight - handleHeight;
                    console.log('è¯·æ±‚åŒºåŸŸè¾¾åˆ°æœ€å°é«˜åº¦ï¼Œè°ƒæ•´å“åº”åŒºåŸŸ:', newResponseHeight);
                }
                if (newResponseHeight < minHeight) {
                    newResponseHeight = minHeight;
                    newRequestHeight = containerHeight - minHeight - handleHeight;
                    console.log('å“åº”åŒºåŸŸè¾¾åˆ°æœ€å°é«˜åº¦ï¼Œè°ƒæ•´è¯·æ±‚åŒºåŸŸ:', newRequestHeight);
                }

                // åº”ç”¨æ–°é«˜åº¦
                requestSection.style.height = newRequestHeight + 'px';
                responseSection.style.height = newResponseHeight + 'px';
                
                console.log('åº”ç”¨æ–°é«˜åº¦:', {
                    requestHeight: newRequestHeight + 'px',
                    responseHeight: newResponseHeight + 'px'
                });
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveResizeState(newRequestHeight, newResponseHeight);
            });

            // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    console.log('é¼ æ ‡é‡Šæ”¾ï¼Œç»“æŸæ‹–æ‹½');
                    isResizing = false;
                    document.body.classList.remove('resizing');
                }
            });

            // åŠ è½½ä¿å­˜çš„å°ºå¯¸
            loadResizeState();
            
            console.log('æ‹–æ‹½åˆ†éš”çº¿è®¾ç½®å®Œæˆ');
        }

        // ä¿å­˜æ‹–æ‹½çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
        function saveResizeState(requestHeight, responseHeight) {
            console.log('ä¿å­˜æ‹–æ‹½çŠ¶æ€:', { requestHeight, responseHeight });
            try {
                const state = {
                    requestHeight: requestHeight,
                    responseHeight: responseHeight,
                    timestamp: Date.now()
                };
                localStorage.setItem('postman-resize-state', JSON.stringify(state));
                console.log('æ‹–æ‹½çŠ¶æ€ä¿å­˜æˆåŠŸ:', state);
            } catch (error) {
                console.warn('ä¿å­˜æ‹–æ‹½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ‹–æ‹½çŠ¶æ€
        function loadResizeState() {
            console.log('å¼€å§‹åŠ è½½æ‹–æ‹½çŠ¶æ€...');
            try {
                const saved = localStorage.getItem('postman-resize-state');
                console.log('ä»æœ¬åœ°å­˜å‚¨è¯»å–çš„æ•°æ®:', saved);
                
                if (saved) {
                    const state = JSON.parse(saved);
                    console.log('è§£æçš„çŠ¶æ€æ•°æ®:', state);
                    
                    const container = document.querySelector('.resizable-container');
                    const requestSection = document.querySelector('.request-section');
                    const responseSection = document.querySelector('.response-section');
                    const resizeHandle = document.getElementById('resizeHandle');
                    
                    console.log('åŠ è½½çŠ¶æ€æ—¶çš„å…ƒç´ æ£€æŸ¥:', {
                        container: !!container,
                        requestSection: !!requestSection,
                        responseSection: !!responseSection,
                        resizeHandle: !!resizeHandle
                    });
                    
                    if (container && requestSection && responseSection && resizeHandle) {
                        const containerHeight = container.offsetHeight;
                        const handleHeight = resizeHandle.offsetHeight;
                        const minHeight = 150;
                        
                        console.log('å®¹å™¨å°ºå¯¸:', {
                            containerHeight: containerHeight,
                            handleHeight: handleHeight,
                            minHeight: minHeight
                        });
                        
                        // éªŒè¯ä¿å­˜çš„é«˜åº¦æ˜¯å¦åˆç†
                        let requestHeight = state.requestHeight || containerHeight / 2;
                        let responseHeight = state.responseHeight || containerHeight / 2;
                        
                        console.log('åˆå§‹è®¡ç®—çš„é«˜åº¦:', {
                            requestHeight: requestHeight,
                            responseHeight: responseHeight
                        });
                        
                        // ç¡®ä¿æœ€å°é«˜åº¦
                        if (requestHeight < minHeight) requestHeight = minHeight;
                        if (responseHeight < minHeight) responseHeight = minHeight;
                        
                        // ç¡®ä¿æ€»é«˜åº¦ä¸è¶…è¿‡å®¹å™¨
                        const totalHeight = requestHeight + responseHeight + handleHeight;
                        if (totalHeight > containerHeight) {
                            const ratio = containerHeight / totalHeight;
                            requestHeight *= ratio;
                            responseHeight *= ratio;
                            console.log('è°ƒæ•´åçš„é«˜åº¦:', { requestHeight, responseHeight, ratio });
                        }
                        
                        requestSection.style.height = requestHeight + 'px';
                        responseSection.style.height = responseHeight + 'px';
                        
                        console.log('åº”ç”¨åŠ è½½çš„é«˜åº¦:', {
                            requestHeight: requestHeight + 'px',
                            responseHeight: responseHeight + 'px'
                        });
                    } else {
                        console.warn('åŠ è½½çŠ¶æ€æ—¶éƒ¨åˆ†å…ƒç´ æœªæ‰¾åˆ°');
                    }
                } else {
                    console.log('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ‹–æ‹½çŠ¶æ€');
                }
            } catch (error) {
                console.warn('åŠ è½½æ‹–æ‹½çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // é‡ç½®æ‹–æ‹½çŠ¶æ€
        function resetResizeState() {
            const requestSection = document.querySelector('.request-section');
            const responseSection = document.querySelector('.response-section');
            
            if (requestSection && responseSection) {
                requestSection.style.height = '';
                responseSection.style.height = '';
                localStorage.removeItem('postman-resize-state');
            }
        }

        // æµ‹è¯•æ‹–æ‹½åŠŸèƒ½
        function testResize() {
            console.log('=== å¼€å§‹æµ‹è¯•æ‹–æ‹½åŠŸèƒ½ ===');
            
            const resizeHandle = document.getElementById('resizeHandle');
            const container = document.querySelector('.resizable-container');
            const requestSection = document.querySelector('.request-section');
            const responseSection = document.querySelector('.response-section');
            
            console.log('å…ƒç´ çŠ¶æ€:', {
                resizeHandle: {
                    exists: !!resizeHandle,
                    id: resizeHandle?.id,
                    className: resizeHandle?.className,
                    style: resizeHandle?.style.cssText,
                    offsetHeight: resizeHandle?.offsetHeight
                },
                container: {
                    exists: !!container,
                    className: container?.className,
                    offsetHeight: container?.offsetHeight
                },
                requestSection: {
                    exists: !!requestSection,
                    className: requestSection?.className,
                    offsetHeight: requestSection?.offsetHeight,
                    style: requestSection?.style.cssText
                },
                responseSection: {
                    exists: !!responseSection,
                    className: responseSection?.className,
                    offsetHeight: responseSection?.offsetHeight,
                    style: responseSection?.style.cssText
                }
            });
            
            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            if (resizeHandle) {
                console.log('åˆ†éš”çº¿å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨æ•°é‡:', resizeHandle.onmousedown ? 'æœ‰ mousedown äº‹ä»¶' : 'æ—  mousedown äº‹ä»¶');
            }
            
            // æµ‹è¯•æ‰‹åŠ¨è®¾ç½®é«˜åº¦
            if (requestSection && responseSection) {
                console.log('æµ‹è¯•æ‰‹åŠ¨è®¾ç½®é«˜åº¦...');
                requestSection.style.height = '300px';
                responseSection.style.height = '400px';
                console.log('æ‰‹åŠ¨è®¾ç½®å®Œæˆ');
            }
            
            console.log('=== æ‹–æ‹½åŠŸèƒ½æµ‹è¯•å®Œæˆ ===');
        }
    </script>
</body>
</html>
{{end}} 